<div class="finder-container">
    <div class="finder-progress">
        <div class="progress-bar" id="progressBar"></div>
    </div>
    
    <!-- Step 1: Loan Purpose -->
    <div class="finder-step active" data-step="1">
        <h2>What are you looking to do?</h2>
        <div class="finder-options">
            <label class="finder-option">
                <input type="radio" name="purpose" value="purchase">
                <span class="option-card">
                    <span class="option-icon">üè†</span>
                    <span class="option-title">Purchase a Home</span>
                </span>
            </label>
            <label class="finder-option">
                <input type="radio" name="purpose" value="refinance">
                <span class="option-card">
                    <span class="option-icon">üí∞</span>
                    <span class="option-title">Refinance</span>
                </span>
            </label>
        </div>
    </div>

    <!-- Step 2: Property Type -->
    <div class="finder-step" data-step="2">
        <h2>What type of property?</h2>
        <div class="finder-options">
            <label class="finder-option">
                <input type="radio" name="property" value="primary">
                <span class="option-card">
                    <span class="option-icon">üè°</span>
                    <span class="option-title">Primary Residence</span>
                    <span class="option-desc">Where you'll live most of the year</span>
                </span>
            </label>
            <label class="finder-option">
                <input type="radio" name="property" value="secondary">
                <span class="option-card">
                    <span class="option-icon">üèñÔ∏è</span>
                    <span class="option-title">Second Home</span>
                    <span class="option-desc">Vacation home, not rented</span>
                </span>
            </label>
            <label class="finder-option">
                <input type="radio" name="property" value="investment">
                <span class="option-card">
                    <span class="option-icon">üìà</span>
                    <span class="option-title">Investment Property</span>
                    <span class="option-desc">Rental income property</span>
                </span>
            </label>
        </div>
    </div>

    <!-- Step 3: Income Documentation (dynamic based on property) -->
    <div class="finder-step" data-step="3">
        <h2>How can you document your income?</h2>
        <div class="finder-options" id="incomeOptions">
            <!-- Populated by JavaScript based on property type -->
        </div>
    </div>

    <!-- Step 3b: Own Primary (only for investment purchase) -->
    <div class="finder-step" data-step="3b">
        <h2>Do you currently own a primary residence?</h2>
        <div class="finder-options">
            <label class="finder-option">
                <input type="radio" name="hasPrimary" value="yes">
                <span class="option-card">
                    <span class="option-icon">‚úÖ</span>
                    <span class="option-title">Yes</span>
                    <span class="option-desc">I already own a primary home</span>
                </span>
            </label>
            <label class="finder-option">
                <input type="radio" name="hasPrimary" value="no">
                <span class="option-card">
                    <span class="option-icon">‚ùå</span>
                    <span class="option-title">No</span>
                    <span class="option-desc">This would be my first property</span>
                </span>
            </label>
        </div>
    </div>

    <!-- Step 4: Employment Length -->
    <div class="finder-step" data-step="4">
        <h2>How long have you been employed (or self-employed)?</h2>
        <div class="finder-options">
            <label class="finder-option">
                <input type="radio" name="employment" value="2years">
                <span class="option-card">
                    <span class="option-icon">‚úÖ</span>
                    <span class="option-title">2+ Years</span>
                </span>
            </label>
            <label class="finder-option">
                <input type="radio" name="employment" value="1year">
                <span class="option-card">
                    <span class="option-icon">‚ö†Ô∏è</span>
                    <span class="option-title">1-2 Years</span>
                </span>
            </label>
            <label class="finder-option">
                <input type="radio" name="employment" value="selfemployed">
                <span class="option-card">
                    <span class="option-icon">üíº</span>
                    <span class="option-title">Self-Employed 5+ Years</span>
                    <span class="option-desc">May qualify for Freddie 5-Year Rule</span>
                </span>
            </label>
        </div>
    </div>

    <!-- Step 5: Veteran Status -->
    <div class="finder-step" data-step="5">
        <h2>Are you a veteran or active-duty military?</h2>
        <div class="finder-options" id="veteranOptions">
            <label class="finder-option">
                <input type="radio" name="veteran" value="yes">
                <span class="option-card">
                    <span class="option-icon">üéñÔ∏è</span>
                    <span class="option-title">Yes - VA Eligible</span>
                </span>
            </label>
            <label class="finder-option">
                <input type="radio" name="veteran" value="no">
                <span class="option-card">
                    <span class="option-icon">‚ùå</span>
                    <span class="option-title">No</span>
                </span>
            </label>
        </div>
    </div>

    <!-- Step 6: Credit Score -->
    <div class="finder-step" data-step="6">
        <h2>What's your approximate credit score?</h2>
        <div class="finder-options">
            <label class="finder-option">
                <input type="radio" name="credit" value="720+">
                <span class="option-card">
                    <span class="option-icon">‚≠ê</span>
                    <span class="option-title">720+ (Excellent)</span>
                </span>
            </label>
            <label class="finder-option">
                <input type="radio" name="credit" value="680-719">
                <span class="option-card">
                    <span class="option-icon">üëç</span>
                    <span class="option-title">680-719 (Good)</span>
                </span>
            </label>
            <label class="finder-option">
                <input type="radio" name="credit" value="620-679">
                <span class="option-card">
                    <span class="option-icon">‚ö°</span>
                    <span class="option-title">620-679 (Fair)</span>
                </span>
            </label>
            <label class="finder-option">
                <input type="radio" name="credit" value="below620">
                <span class="option-card">
                    <span class="option-icon">üîß</span>
                    <span class="option-title">Below 620</span>
                </span>
            </label>
        </div>
    </div>

    <!-- Step 7: Down Payment (only for purchase) -->
    <div class="finder-step" data-step="7">
        <h2>How much can you put down?</h2>
        <div class="finder-options" id="downPaymentOptions">
            <label class="finder-option">
                <input type="radio" name="downpayment" value="20+">
                <span class="option-card">
                    <span class="option-icon">üíµ</span>
                    <span class="option-title">20%+</span>
                </span>
            </label>
            <label class="finder-option">
                <input type="radio" name="downpayment" value="10-20">
                <span class="option-card">
                    <span class="option-icon">üí∞</span>
                    <span class="option-title">10-20%</span>
                </span>
            </label>
            <label class="finder-option">
                <input type="radio" name="downpayment" value="3.5-10">
                <span class="option-card">
                    <span class="option-icon">üí≥</span>
                    <span class="option-title">3.5-10%</span>
                </span>
            </label>
            <label class="finder-option">
                <input type="radio" name="downpayment" value="0-3.5">
                <span class="option-card">
                    <span class="option-icon">üÜì</span>
                    <span class="option-title">0-3.5%</span>
                </span>
            </label>
        </div>
    </div>

    <!-- Results -->
    <div class="finder-step" data-step="results">
        <h2>Your Recommended Loan Programs</h2>
        <div id="results"></div>
        <div class="cta-box">
            <h3>Ready to Get Pre-Qualified?</h3>
            <p>Our team will verify these programs and find the best option for you.</p>
            <a href="/prequalify/" class="btn btn-primary">Start Pre-Qualification</a>
        </div>
    </div>

    <!-- Navigation -->
    <div class="finder-nav">
        <button type="button" class="btn btn-secondary" id="prevBtn" disabled>Back</button>
        <button type="button" class="btn btn-primary" id="nextBtn">Next</button>
    </div>
</div>

<style>
.finder-container {
    max-width: 700px;
    margin: 0 auto;
    padding: 20px;
}
.finder-progress {
    height: 4px;
    background: #e2e8f0;
    border-radius: 2px;
    margin-bottom: 30px;
}
.progress-bar {
    height: 100%;
    background: #FC5C06;
    border-radius: 2px;
    transition: width 0.3s ease;
    width: 14%;
}
.finder-step {
    display: none;
}
.finder-step.active {
    display: block;
}
.finder-step h2 {
    text-align: center;
    margin-bottom: 25px;
    color: #010101;
}
.finder-options {
    display: grid;
    gap: 15px;
}
.finder-option {
    cursor: pointer;
}
.finder-option input {
    display: none;
}
.option-card {
    display: flex;
    align-items: center;
    gap: 15px;
    padding: 20px;
    border: 2px solid #e2e8f0;
    border-radius: 8px;
    transition: all 0.2s;
}
.finder-option input:checked + .option-card {
    border-color: #FC5C06;
    background: #fff7ed;
}
.option-icon {
    font-size: 32px;
}
.option-title {
    font-weight: 600;
    font-size: 18px;
}
.option-desc {
    display: block;
    font-size: 14px;
    color: #64748b;
    margin-top: 4px;
}
.finder-nav {
    display: flex;
    justify-content: space-between;
    margin-top: 30px;
}
.finder-nav .btn {
    min-width: 120px;
}
.result-card {
    background: #f8fafc;
    border: 1px solid #e2e8f0;
    border-radius: 8px;
    padding: 20px;
    margin-bottom: 15px;
}
.result-card h3 {
    color: #010101;
    margin-bottom: 10px;
}
.result-card .match-score {
    display: inline-block;
    background: #10b981;
    color: white;
    padding: 4px 12px;
    border-radius: 20px;
    font-size: 14px;
    margin-bottom: 10px;
}
.result-card ul {
    margin: 10px 0;
    padding-left: 20px;
}
.result-card li {
    margin-bottom: 5px;
}
.note-card {
    background: #fef3c7;
    border: 1px solid #f59e0b;
    padding: 15px;
    border-radius: 8px;
    margin-bottom: 15px;
}
.note-card p {
    margin: 0;
    color: #92400e;
}
</style>

<script>
(function() {
    let currentStep = 1;
    let maxStep = 7;
    const answers = {};

    // Store step configurations
    let stepConfig = {
        property: null,
        purpose: null
    };

    function updateProgress() {
        let progress = 0;
        if (currentStep === 1) progress = 14;
        else if (currentStep === 2) progress = 28;
        else if (currentStep === 3) progress = 42;
        else if (currentStep === 3.5) progress = 50;
        else if (currentStep === 4) progress = 60;
        else if (currentStep === 5) progress = 75;
        else if (currentStep === 6) progress = 85;
        else if (currentStep === 7) progress = 95;
        else if (currentStep === 8) progress = 100;
        
        const bar = document.getElementById('progressBar');
        if (bar) bar.style.width = progress + '%';
    }

    function showStep(step) {
        document.querySelectorAll('.finder-step').forEach(s => s.classList.remove('active'));
        
        let stepEl;
        if (step === 3.5) {
            stepEl = document.querySelector('[data-step="3b"]');
        } else {
            stepEl = document.querySelector('[data-step="' + step + '"]');
        }
        
        if (stepEl) stepEl.classList.add('active');
        
        const prevBtn = document.getElementById('prevBtn');
        const nextBtn = document.getElementById('nextBtn');
        
        if (prevBtn) prevBtn.disabled = step === 1;
        
        if (nextBtn) {
            if (step === maxStep || (step === 3.5 && maxStep === 3.5)) {
                nextBtn.textContent = 'See Results';
            } else {
                nextBtn.textContent = 'Next';
            }
        }
        
        updateProgress();
    }

    function saveAnswer() {
        const currentQuestion = document.querySelector('.finder-step.active');
        if (!currentQuestion) return;
        
        const radio = currentQuestion.querySelector('input[type="radio"]:checked');
        if (radio) {
            answers[radio.name] = radio.value;
            
            // Track property and purpose changes
            if (radio.name === 'property') {
                stepConfig.property = radio.value;
                populateIncomeOptions(radio.value);
                populateVeteranOptions();
                updateMaxStep();
            }
            if (radio.name === 'purpose') {
                stepConfig.purpose = radio.value;
                updateDownPaymentOptions();
                updateMaxStep();
            }
        }
    }

    function populateIncomeOptions(propertyType) {
        const container = document.getElementById('incomeOptions');
        if (!container) return;
        
        let html = '';
        
        if (propertyType === 'secondary') {
            // Second home - only tax returns
            html = `
                <label class="finder-option">
                    <input type="radio" name="income" value="taxes" checked>
                    <span class="option-card">
                        <span class="option-icon">üìÑ</span>
                        <span class="option-title">Tax Returns / W-2s</span>
                        <span class="option-desc">Standard 2 years of tax returns required</span>
                    </span>
                </label>
            `;
        } else if (propertyType === 'investment') {
            // Investment - all options
            html = `
                <label class="finder-option">
                    <input type="radio" name="income" value="taxes">
                    <span class="option-card">
                        <span class="option-icon">üìÑ</span>
                        <span class="option-title">Tax Returns / W-2s</span>
                        <span class="option-desc">Standard 2 years of tax returns</span>
                    </span>
                </label>
                <label class="finder-option">
                    <input type="radio" name="income" value="bank">
                    <span class="option-card">
                        <span class="option-icon">üè¶</span>
                        <span class="option-title">Bank Statements</span>
                        <span class="option-desc">12-24 months of bank statements</span>
                    </span>
                </label>
                <label class="finder-option">
                    <input type="radio" name="income" value="none">
                    <span class="option-card">
                        <span class="option-icon">üìà</span>
                        <span class="option-title">No Income Verification</span>
                        <span class="option-desc">Based on property cash flow (DSCR)</span>
                    </span>
                </label>
            `;
        } else {
            // Primary residence - all options with correct descriptions
            html = `
                <label class="finder-option">
                    <input type="radio" name="income" value="taxes">
                    <span class="option-card">
                        <span class="option-icon">üìÑ</span>
                        <span class="option-title">Tax Returns / W-2s</span>
                        <span class="option-desc">Standard 2 years of tax returns</span>
                    </span>
                </label>
                <label class="finder-option">
                    <input type="radio" name="income" value="bank">
                    <span class="option-card">
                        <span class="option-icon">üè¶</span>
                        <span class="option-title">Bank Statements</span>
                        <span class="option-desc">12-24 months of business/personal bank statements</span>
                    </span>
                </label>
                <label class="finder-option">
                    <input type="radio" name="income" value="none">
                    <span class="option-card">
                        <span class="option-icon">üíº</span>
                        <span class="option-title">Cannot Document Income</span>
                        <span class="option-desc">Can verify employment 2+ years but no tax returns</span>
                    </span>
                </label>
            `;
        }
        
        container.innerHTML = html;
    }

    function populateVeteranOptions() {
        const container = document.getElementById('veteranOptions');
        if (!container) return;
        
        // VA only for primary residence
        if (stepConfig.property === 'primary') {
            container.innerHTML = `
                <label class="finder-option">
                    <input type="radio" name="veteran" value="yes">
                    <span class="option-card">
                        <span class="option-icon">üéñÔ∏è</span>
                        <span class="option-title">Yes - VA Eligible</span>
                    </span>
                </label>
                <label class="finder-option">
                    <input type="radio" name="veteran" value="no">
                    <span class="option-card">
                        <span class="option-icon">‚ùå</span>
                        <span class="option-title">No</span>
                    </span>
                </label>
            `;
        } else {
            // Not primary - skip veteran question
            container.innerHTML = `
                <label class="finder-option">
                    <input type="radio" name="veteran" value="no" checked style="display:none;">
                </label>
            `;
            answers.veteran = 'no';
        }
    }

    function updateDownPaymentOptions() {
        const container = document.getElementById('downPaymentOptions');
        if (!container) return;
        
        if (stepConfig.purpose === 'refinance') {
            // Refinance - different options
            container.innerHTML = `
                <label class="finder-option">
                    <input type="radio" name="downpayment" value="refinance" checked>
                    <span class="option-card">
                        <span class="option-icon">üè†</span>
                        <span class="option-title">Refinancing My Current Home</span>
                        <span class="option-desc">Already own the property</span>
                    </span>
                </label>
            `;
        } else {
            // Purchase - original options
            container.innerHTML = `
                <label class="finder-option">
                    <input type="radio" name="downpayment" value="20+">
                    <span class="option-card">
                        <span class="option-icon">üíµ</span>
                        <span class="option-title">20%+</span>
                    </span>
                </label>
                <label class="finder-option">
                    <input type="radio" name="downpayment" value="10-20">
                    <span class="option-card">
                        <span class="option-icon">üí∞</span>
                        <span class="option-title">10-20%</span>
                    </span>
                </label>
                <label class="finder-option">
                    <input type="radio" name="downpayment" value="3.5-10">
                    <span class="option-card">
                        <span class="option-icon">üí≥</span>
                        <span class="option-title">3.5-10%</span>
                    </span>
                </label>
                <label class="finder-option">
                    <input type="radio" name="downpayment" value="0-3.5">
                    <span class="option-card">
                        <span class="option-icon">üÜì</span>
                        <span class="option-title">0-3.5%</span>
                    </span>
                </label>
            `;
        }
    }

    function updateMaxStep() {
        // Refinance: skip down payment (step 7), skip hasPrimary
        if (stepConfig.purpose === 'refinance') {
            maxStep = 6; // Ends at credit score
        }
        // Investment purchase: add hasPrimary question (step 3.5)
        else if (stepConfig.purpose === 'purchase' && stepConfig.property === 'investment') {
            maxStep = 7;
        }
        // Primary/Second home purchase: normal flow
        else {
            maxStep = 7;
        }
    }

    function calculateResults() {
        const results = [];
        
        const purpose = answers[1]; // purchase/refinance
        const property = answers[2]; // primary/secondary/investment
        const income = answers[3]; // taxes/bank/none
        const hasPrimary = answers['3b']; // yes/no (for investment)
        const veteran = answers[5]; // yes/no
        const credit = answers[6]; // 720+/680-719/620-679/below620
        const downPayment = answers[7]; // 20+/10-20/3.5-10/0-3.5
        
        // VA Loan
        if (veteran === 'yes' && property === 'primary') {
            results.push({
                name: 'VA Loan',
                score: '100% Match',
                desc: '0% down, no PMI, competitive rates for veterans.',
                bestFor: ['No down payment needed', 'No PMI required', 'Flexible credit'],
                icon: 'üéñÔ∏è'
            });
        }

        // Conventional
        if (property === 'primary' || property === 'secondary') {
            if (income === 'taxes') {
                if (credit === '720+' || credit === '680-719') {
                    if (downPayment === '20+' || downPayment === '10-20') {
                        results.push({
                            name: 'Conventional Loan',
                            score: '95% Match',
                            desc: 'Best rates for borrowers with good credit and income.',
                            bestFor: ['Competitive interest rates', 'PMI can be removed at 20% equity', 'Lower overall costs'],
                            icon: 'üè¶'
                        });
                    }
                }
            }
        }

        // FHA - Primary only, not investment
        if (property === 'primary' && (credit === '620-679' || credit === 'below620' || downPayment === '3.5-10' || downPayment === '0-3.5')) {
            results.push({
                name: 'FHA Loan',
                score: '90% Match',
                desc: '3.5% down, flexible credit requirements.',
                bestFor: ['Lower credit scores OK', 'Gift funds allowed', 'Fixed and ARM options'],
                icon: 'üè†'
            });
        }

        // Bank Statement Loan - Primary or Investment
        if (income === 'bank' && property !== 'secondary') {
            results.push({
                name: 'Bank Statement Loan',
                score: '95% Match',
                desc: 'Use 12-24 months of bank statements instead of tax returns.',
                bestFor: ['Self-employed borrowers', 'High deductions', '1099 income'],
                icon: 'üíº'
            });
        }

        // DSCR - Investment property ONLY
        if (property === 'investment' && income === 'none') {
            results.push({
                name: 'DSCR Loan',
                score: '100% Match',
                desc: 'No income verification. Qualifies based on property cash flow.',
                bestFor: ['No tax returns needed', 'Investor properties', 'Cash flow qualification'],
                icon: 'üìà'
            });
        }

        // Freddie 5-Year Rule - Self-employed 5+ years
        if (answers[4] === 'selfemployed') {
            results.push({
                name: 'Freddie Mac (5-Year Rule)',
                score: 'Best for Self-Employed',
                desc: 'If you have 5+ years self-employed, only 1 year of tax returns needed.',
                bestFor: ['Established business owners', 'Strong recent income', 'Better rates than non-QM'],
                icon: '‚≠ê'
            });
        }

        // Note for investment without primary
        if (purpose === 'purchase' && property === 'investment' && hasPrimary === 'no') {
            results.unshift({
                name: 'Note',
                isNote: true,
                text: 'Most investors prefer you to own a primary residence first before purchasing an investment property. However, we can discuss your specific situation.'
            });
        }

        return results;
    }

    function showResults() {
        const results = calculateResults();
        const container = document.getElementById('results');
        
        if (results.length === 0) {
            container.innerHTML = '<p>Based on your answers, we recommend speaking with a lender to discuss your options. Every situation is unique!</p>';
        } else {
            container.innerHTML = results.map(r => {
                if (r.isNote) {
                    return `<div class="note-card"><p>${r.text}</p></div>`;
                }
                return `
                    <div class="result-card">
                        <span class="match-score">${r.score}</span>
                        <h3>${r.icon} ${r.name}</h3>
                        <p>${r.desc}</p>
                        <ul>
                            ${r.bestFor.map(item => `<li>${item}</li>`).join('')}
                        </ul>
                    </div>
                `;
            }).join('');
        }
        
        document.querySelector('[data-step="results"]').classList.add('active');
        updateProgress();
        document.querySelector('.finder-nav').style.display = 'none';
    }

    document.getElementById('nextBtn').addEventListener('click', function() {
        saveAnswer();
        
        // Check if we need to show hasPrimary question
        if (currentStep === 3 && stepConfig.purpose === 'purchase' && stepConfig.property === 'investment') {
            currentStep = 3.5;
            showStep(currentStep);
            return;
        }
        
        // Skip veteran step if not primary
        if (currentStep === 4 && stepConfig.property !== 'primary') {
            currentStep = 5; // Skip to credit
            showStep(currentStep);
            return;
        }
        
        // Skip down payment for refinance
        if (currentStep === 5 && stepConfig.purpose === 'refinance') {
            currentStep = 8; // Skip to results
            showStep(currentStep);
            return;
        }
        
        if (currentStep < maxStep) {
            currentStep++;
            showStep(currentStep);
        } else {
            showResults();
        }
    });

    document.getElementById('prevBtn').addEventListener('click', function() {
        // Handle going back from hasPrimary
        if (currentStep === 3.5) {
            currentStep = 3;
            showStep(currentStep);
            return;
        }
        
        // Handle going back past veteran skip
        if (currentStep === 5 && stepConfig.property !== 'primary' && answers[4]) {
            currentStep = 4;
            showStep(currentStep);
            return;
        }
        
        // Handle going back past down payment skip
        if (currentStep === 6 && stepConfig.purpose === 'refinance' && answers[6]) {
            currentStep = 5;
            showStep(currentStep);
            return;
        }
        
        if (currentStep > 1) {
            currentStep--;
            showStep(currentStep);
        }
    });

    // Initialize
    populateIncomeOptions('primary');
    populateVeteranOptions();
})();
</script>
